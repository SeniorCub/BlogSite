<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Amebo</title>
    <!-- Bootstrap link -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
    <!-- dotlottie -->
    <script src="https://unpkg.com/@dotlottie/player-component@latest/dist/dotlottie-player.mjs" type="module"></script> 
    <!-- favicon -->
     <link rel="icon" href="media/logo.png">
    <!-- Font Awsome -->
    <link rel="stylesheet" href="./fontawesome-free-6.5.1-web/css/all.css">
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="blog.css">
    <link rel="stylesheet" href="admin.css">
</head>
<body style="position: relative;">

     <!-- Nvavbar -->
     <nav class="navbar navbar-expand-lg">
          <div class="container-fluid">
               <a class="navbar-brand" href="./"><img src="media/logo.png">mebo</a>
               <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNavAltMarkup" aria-controls="navbarNavAltMarkup" aria-expanded="false" aria-label="Toggle navigation">
               <span class="navbar-toggler-icon"></span>
               </button>
               <div class="collapse navbar-collapse" id="navbarNavAltMarkup">
                    <div class="navbar-nav ms-auto gap-lg-5">
                         <a class="nav-link active" aria-current="page" href="./">Home</a>
                         <a class="nav-link" href="./cartigory.html">Blog</a>
                         <a class="nav-link" href="./about.html">About</a>
                         <a class="nav-link" href="./about.html">Contact</a>
                    </div>
               </div>
          </div>
     </nav>
     
     <section class="header">
          <div class="welcome">
              Welcome back, <span>admin!</span><br> What can we help you with?
          </div>
          <div class="images">
              <dotlottie-player src="https://lottie.host/cc8dbffc-10fb-4872-ad02-c6ab31360a35/Ds7plr4VBf.lottie" background="transparent" speed="1" style="width: 300px; height: 300px;" loop autoplay></dotlottie-player>
          </div>
     </section>


     <!-- News Update Section -->
     <section id="newss">
          <!-- Create Button -->
          <div class="d-flex justify-content-between advert">
               <div class="textss">Create a new Blog</div>
               <button id="uploadnews">
                   <span>
                       <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="24" height="24">
                           <path fill="none" d="M0 0h24v24H0z"></path>
                           <path fill="currentColor" d="M11 11V5h2v6h6v2h-6v6h-2v-6H5v-2z"></path>
                       </svg> Create Blog
                   </span>
               </button>
          </div>
          <h1>News</h1>
          <section id="blogList" class="newss"></section>
     </section>

     <section id="newForm">
          <h1>Create new Blog</h1>
          <div class="close newClose">X</div>
          <form id="new-form" enctype="multipart/form-data">
              <!-- Title -->
              <label for="title"></label>
              <input type="text" name="title" id="title" placeholder="title">
              <br>
              <!-- Content -->
              <label for="content"></label>
              <textarea name="content" id="content" placeholder="content" cols="30" rows="10"></textarea>
              <br>
              <div class="d-flex">
                  <!-- Author name -->
                  <div class="w-50">
                      <label for="author"></label>
                      <input type="text" name="author" id="author" placeholder="author">
                  </div>
                  <!-- Category -->
                  <div class="w-50">
                      <label for="category"></label>
                      <input type="text" name="category" id="category" placeholder="category">
                  </div>
              </div>
              <br>
              <!-- Quote from the Artist -->
              <label for="quote"></label>
              <textarea name="quote" id="quote" placeholder="quote from the artist" cols="30" rows="1"></textarea>
              <br>
              <div class="d-flex gap-5">
                  <!-- Upload artist Image -->
                  <div class="d-flex gap-2 w-50">
                      <div class="w-50">
                          <label for="airtistImg" class="image-label">
                              <h1>+</h1>
                              <p>Add artist image</p>
                              <p>max size 5mb</p>
                          </label>
                          <input type="file" name="airtistImg" id="airtistImg">
                      </div>
                      <div class="w-50 airtistImg"></div>
                  </div>
                  <!-- Upload Cover image -->
                  <div class="d-flex gap-2 w-50">
                      <div class="w-50">
                          <label for="imageCover" class="image-label">
                              <h1>+</h1>
                              <p>Add blog cover image</p>
                              <p>max size 5mb</p>
                          </label>
                          <input type="file" name="imageCover" id="imageCover">
                      </div>
                      <div class="w-50 imageCover"></div>
                  </div>
              </div>
              <br>
              <button type="submit" class="upload-btn">Create News</button>
          </form>
     </section>
      

     <div id="alerting"></div>
     <svg xmlns="http://www.w3.org/2000/svg" class="d-none">
          <symbol id="check-circle-fill" viewBox="0 0 16 16">
            <path d="M16 8A8 8 0 1 1 0 8a8 8 0 0 1 16 0zm-3.97-3.03a.75.75 0 0 0-1.08.022L7.477 9.417 5.384 7.323a.75.75 0 0 0-1.06 1.06L6.97 11.03a.75.75 0 0 0 1.079-.02l3.992-4.99a.75.75 0 0 0-.01-1.05z"/>
          </symbol>
          <symbol id="info-fill" viewBox="0 0 16 16">
            <path d="M8 16A8 8 0 1 0 8 0a8 8 0 0 0 0 16zm.93-9.412-1 4.705c-.07.34.029.533.304.533.194 0 .487-.07.686-.246l-.088.416c-.287.346-.92.598-1.465.598-.703 0-1.002-.422-.808-1.319l.738-3.468c.064-.293.006-.399-.287-.47l-.451-.081.082-.381 2.29-.287zM8 5.5a1 1 0 1 1 0-2 1 1 0 0 1 0 2z"/>
          </symbol>
          <symbol id="exclamation-triangle-fill" viewBox="0 0 16 16">
            <path d="M8.982 1.566a1.13 1.13 0 0 0-1.96 0L.165 13.233c-.457.778.091 1.767.98 1.767h13.713c.889 0 1.438-.99.98-1.767L8.982 1.566zM8 5c.535 0 .954.462.9.995l-.35 3.507a.552.552 0 0 1-1.1 0L7.1 5.995A.905.905 0 0 1 8 5zm.002 6a1 1 0 1 1 0 2 1 1 0 0 1 0-2z"/>
          </symbol>
     </svg>

     <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
     <script src="admin.js"></script>
     <script>
          let alerting = document.getElementById('alerting');
      
          function getToken() {
              return localStorage.getItem('token');
          }
      
          function saveToken(token) {
              localStorage.setItem('token', token);
          }
      
          function logout() {
              localStorage.removeItem('token');
              window.location.href = '/login.html';
          }
      
          function showAlertAndLogout(message) {
              alerting.innerHTML = `
                  <div class="alert alert-danger d-flex align-items-center" role="alert">
                      <svg class="bi flex-shrink-0 me-2" role="img" aria-label="Danger:">
                          <use xlink:href="#exclamation-triangle-fill"/>
                      </svg>
                      <div>
                          ${message}
                      </div>
                  </div>
              `;
              setTimeout(() => {
                  logout();
              }, 10000); // Wait for 10 seconds before logging out
          }
      
          function checkToken() {
              const token = getToken();
              if (!token) {
                  showAlertAndLogout('An error occurred submitting your request. Check your network connection');
                  return;
              }
      
              const payload = JSON.parse(atob(token.split('.')[1]));
              const expiry = payload.exp * 1000;
              const now = Date.now();
      
              if (now > expiry) {
                  showAlertAndLogout('Session expired. You will be logged out.');
              }
          }
          const newForm = document.getElementById('new-form');

          document.getElementById('new-form').addEventListener('submit', async function (e) {
              e.preventDefault();
              const formData = new FormData(this);
      
              try {
                  const response = await fetch('/api/v1/blog/upload', {
                      method: 'POST',
                      body: formData
                  });
      
                  const data = await response.json();
      
                  if (data.success) {
                    newForm.style.display="none";
                      alerting.innerHTML = `
                      <div class="alert alert-success d-flex align-items-center" role="alert">
                          <svg class="bi flex-shrink-0 me-2" role="img" aria-label="Success:"><use xlink:href="#info-fill"/></svg>
                          <div>
                          Successfully Created
                          </div>
                      </div>
                      `;
                  } else {
                      alerting.innerHTML = `
                      <div class="alert alert-warning d-flex align-items-center" role="alert">
                          <svg class="bi flex-shrink-0 me-2" role="img" aria-label="Danger:"><use xlink:href="#exclamation-triangle-fill"/></svg>
                          <div>
                          An error occurred submitting your request
                          </div>
                      </div>`;
                  }
                  setTimeout(() => {
                      alerting.innerHTML = "";
                  }, 5000); // Clear alert after 5 seconds
      
              } catch (error) {
                  alerting.innerHTML = `
                  <div class="alert alert-danger d-flex align-items-center" role="alert">
                      <svg class="bi flex-shrink-0 me-2" role="img" aria-label="Danger:"><use xlink:href="#exclamation-triangle-fill"/></svg>
                      <div>
                      An error occurred submitting your request
                      </div>
                  </div>`;
                  setTimeout(() => {
                      alerting.innerHTML = "";
                  }, 5000); // Clear alert after 5 seconds
              }
          });
           
          

               function showAlert(message, type) {
                    alerting.innerHTML = `
                         <div class="alert alert-${type} d-flex align-items-center" role="alert">
                              <svg class="bi flex-shrink-0 me-2" role="img" aria-label="${type.charAt(0).toUpperCase() + type.slice(1)}:"><use xlink:href="#${type === 'danger' ? 'exclamation-triangle-fill' : 'info-fill'}"/></svg>
                              <div>${message}</div>
                         </div>`;
                    setTimeout(() => {
                         alerting.innerHTML = "";
                    }, 5000);
               }

               function fetchBlogs() {
                    axios.get('/api/v1/blog/blogss')
                         .then(response => {
                              const blogs = response.data;
                              const blogList = document.getElementById('blogList');
                              blogList.innerHTML = '';

                              blogs.forEach(blog => {
                                   const blogItem = document.createElement('div');
                                   blogItem.classList.add('news');
                                   blogItem.innerHTML = `
                                   <div class="infromate">
                                        <h2 class="title">${blog.title}</h2>
                                        <p class="content">${blog.content}</p>
                                        <div class="d-flex gap-3">
                                             <p class="author">${blog.author}</p>
                                             <p class="category">${blog.category}</p>
                                        </div>
                                        <p class="publication_date">${new Date(blog.updatedAt).toLocaleDateString()}</p>
                                   </div>
                                   <div class="btns">
                                        <button class="delbutton editBtn" type="button" onclick="updateNews('${blog._id}')">
                                             <span class="button__text">Edit</span>
                                             <span class="button__icon">
                                                  <svg viewBox="0 0 512 512" class="svg">
                                                       <path d="M410.3 231l11.3-11.3-33.9-33.9-62.1-62.1L291.7 89.8l-11.3 11.3-22.6 22.6L58.6 322.9c-10.4 10.4-18 23.3-22.2 37.4L1 480.7c-2.5 8.4-.2 17.5 6.1 23.7s15.3 8.5 23.7 6.1l120.3-35.4c14.1-4.2 27-11.8 37.4-22.2L387.7 253.7 410.3 231zM160 399.4l-9.9 9.9c-5.8 5.8-12.9 10.1-20.7 12.6l-81.3 23.9 23.9-81.3c2.5-7.8 6.8-14.9 12.6-20.7l9.9-9.9L255 183.3l66.8 66.8L160 399.4zM476.2 101.7L457.6 83c-11-11-28.7-11-39.7 0L392 108.9l61.1 61.1L476.2 141c11-11 11-28.7 0-39.7z"/>
                                                  </svg>
                                             </span>
                                        </button>
                                        <button class="delbutton deleteBtn" type="button" onclick="deleteBlog('${blog._id}')">
                                             <span class="button__text">Delete</span>
                                             <span class="button__icon">
                                                  <svg viewBox="0 0 448 512" class="svg">
                                                       <path d="M160 400C160 413.3 149.3 424 136 424C122.7 424 112 413.3 112 400V176C112 162.7 122.7 152 136 152C149.3 152 160 162.7 160 176V400zM240 400C240 413.3 229.3 424 216 424C202.7 424 192 413.3 192 400V176C192 162.7 202.7 152 216 152C229.3 152 240 162.7 240 176V400zM320 400C320 413.3 309.3 424 296 424C282.7 424 272 413.3 272 400V176C272 162.7 282.7 152 296 152C309.3 152 320 162.7 320 176V400zM432 80C432 106.5 410.5 128 384 128H384.9L364.3 448.2C362.8 474.5 342.4 494.4 316.1 495.9C289.7 497.4 269.8 477 268.3 450.7L268.2 450.2L252.5 160H195.5L179.8 450.2L179.7 450.7C178.2 477 158.3 497.4 131.9 495.9C105.6 494.4 85.22 474.5 83.69 448.2L63.06 128H64C37.49 128 16 106.5 16 80C16 53.49 37.49 32 64 32H160C160 14.33 174.3 0 192 0H256C273.7 0 288 14.33 288 32H384C410.5 32 432 53.49 432 80zM255.1 32H191.1V64H255.1V32zM366.9 128L347.3 447.8C347 451.8 343.5 455.1 339.5 455.1C335.4 455.1 332 451.8 331.7 447.8L311.1 128H136.9L116.3 447.8C115.1 451.8 111.6 455.1 107.5 455.1C103.5 455.1 100 451.8 99.69 447.8L80.09 128H64C55.16 128 48 120.8 48 112C48 103.2 55.16 96 64 96H384C392.8 96 400 103.2 400 112C400 120.8 392.8 128 384 128H366.9z"/>
                                                  </svg>
                                             </span>
                                        </button>
                                   </div>`;
                                   blogList.appendChild(blogItem);
                              });
                         })
                         .catch(error => console.error(error));
               }

               newForm.addEventListener('submit', (event) => {
                    event.preventDefault();
                    const formData = new FormData(newForm);

                    axios.post('/api/v1/blog/upload', formData, {
                         headers: {
                              'Content-Type': 'multipart/form-data'
                         }
                    })
                    .then(response => {
                         showAlert(response.data.msg, 'success');
                         newForm.reset();
                         fetchBlogs();
                    })
                    .catch(error => {
                         showAlert(error.response.data.msg, 'danger');
                    });
               });

               fetchBlogs();


           function deleteBlog(blogId) {
               if (confirm('Are you sure you want to delete this blog?')) {
                   axios.delete(`/api/v1/blog/blogss/${blogId}`)
                       .then(response => {
                           showAlert(response.data.msg, 'success');
                           fetchBlogs();
                       })
                       .catch(error => {
                           showAlert(error.response.data.msg, 'danger');
                       });
               }
           }
         // Update Blog
          function updateNews(news_id) {
               console.log('Updating blog with ID:', news_id); // Debugging
          
               axios.get(`/api/v1/blog/blogss/${news_id}`)
               .then(response => {
                    const blog = response.data;
          
                    // Debugging: log the blog data
                    console.log('Fetched blog data:', blog);
          
                    // Populate the form with existing blog details for editing
                    if (blog.title) {
                         document.getElementById('title').value = blog.title;
                    }
                    if (blog.content) {
                         document.getElementById('content').value = blog.content;
                    }
                    if (blog.author) {
                         document.getElementById('author').value = blog.author;
                    }
                    if (blog.category) {
                         document.getElementById('category').value = blog.category;
                    }
                    if (blog.quote) {
                         document.getElementById('quote').value = blog.quote;
                    }
          
                    // Populate image containers with existing images
                    if (blog.airtistImg) {
                         const airtistImgContainer = document.querySelector('.airtistImg');
                         airtistImgContainer.innerHTML = `<img src="${blog.airtistImg}" alt="Artist Image" style="max-width: 100%; max-height: 100%;">`;
                    }
                    if (blog.imageCover) {
                         const imageCoverContainer = document.querySelector('.imageCover');
                         imageCoverContainer.innerHTML = `<img src="${blog.imageCover}" alt="Cover Image" style="max-width: 100%; max-height: 100%;">`;
                    }
                    if (blog.image) {
                         const imageSpaceContainer = document.querySelector('.image-space');
                         imageSpaceContainer.innerHTML = `<img src="${blog.image}" alt="Blog Image" style="max-width: 100%; max-height: 100%;">`;
                    }
          
                    // Update form submission to handle editing
                    const form = document.getElementById('new-form');
                    document.querySelector("#newForm").style.display = "block";
                    form.onsubmit = async function (e) {
                         e.preventDefault();
                         const formData = new FormData(this);
                         formData.append('news_id', news_id); // Add news_id to the form data
          
                         try {
                              const response = await fetch(`/api/v1/blog/blogss/${news_id}`, {
                                   method: 'PUT',
                                   body: formData
                              });
          
                              const data = await response.json();
                              if (data.success) {
                                   showAlert('Blog updated successfully', 'success');
                              } else {
                                   showAlert('An error occurred updating the blog', 'danger');
                              }
                              fetchBlogs(); // Refresh blog list
                         } catch (error) {
                              showAlert('An error occurred updating the blog', 'danger');
                         }
                    };
               })
               .catch(error => {
                    showAlert('Failed to fetch blog details', 'danger');
                    console.error('Error fetching blog details:', error);
               });
          }
          
          
          // Call fetchBlogs on page load
          window.onload = () => {
               fetchBlogs();
               checkToken();
               setInterval(checkToken, 60 * 1000); // Check every minute
          };
     </script>
      
</body>
</html>