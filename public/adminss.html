<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Amebo</title>
    <!-- Bootstrap link -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
    <!-- dotlottie -->
    <script src="https://unpkg.com/@dotlottie/player-component@latest/dist/dotlottie-player.mjs" type="module"></script> 
    <!-- favicon -->
     <link rel="icon" href="media/logo.png">
    <!-- Font Awsome -->
    <link rel="stylesheet" href="./fontawesome-free-6.5.1-web/css/all.css">
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="blog.css">
    <link rel="stylesheet" href="admin.css">
</head>
<body style="position: relative;">

     <!-- Nvavbar -->
     <nav class="navbar navbar-expand-lg">
          <div class="container-fluid">
               <a class="navbar-brand" href="./"><img src="media/logo.png">mebo</a>
               <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNavAltMarkup" aria-controls="navbarNavAltMarkup" aria-expanded="false" aria-label="Toggle navigation">
               <span class="navbar-toggler-icon"></span>
               </button>
               <div class="collapse navbar-collapse" id="navbarNavAltMarkup">
                    <div class="navbar-nav ms-auto gap-lg-5">
                         <a class="nav-link active" aria-current="page" href="./">Home</a>
                         <a class="nav-link" href="./cartigory.html">Blog</a>
                         <a class="nav-link" href="./about.html">About</a>
                         <a class="nav-link" href="./about.html">Contact</a>
                    </div>
               </div>
          </div>
     </nav>
     
     <section class="header">
          <div class="welcome">
              Welcome back, <span>admin!</span><br> What can we help you with?
          </div>
          <div class="images">
              <dotlottie-player src="https://lottie.host/cc8dbffc-10fb-4872-ad02-c6ab31360a35/Ds7plr4VBf.lottie" background="transparent" speed="1" style="width: 300px; height: 300px;" loop autoplay></dotlottie-player>
          </div>
     </section>


     <!-- News Update Section -->
     <section id="newss">
          <!-- Create Button -->
          <div class="d-flex justify-content-between advert">
               <div class="textss">Create a new Blog</div>
               <button id="uploadnews">
                   <span>
                       <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="24" height="24">
                           <path fill="none" d="M0 0h24v24H0z"></path>
                           <path fill="currentColor" d="M11 11V5h2v6h6v2h-6v6h-2v-6H5v-2z"></path>
                       </svg> Create Blog
                   </span>
               </button>
          </div>
          <h1>News</h1>
          <section id="blogList" class="newss"></section>
     </section>

     <section id="newForm">
          <h1>Create new Blog</h1>
          <div class="close newClose">X</div>
          <form id="new-form" enctype="multipart/form-data">
              <!-- Title -->
              <label for="title"></label>
              <input type="text" name="title" id="title" placeholder="title">
              <br>
              <!-- Content -->
              <label for="content"></label>
              <textarea name="content" id="content" placeholder="content" cols="30" rows="10"></textarea>
              <br>
              <div class="d-flex">
                  <!-- Author name -->
                  <div class="w-50">
                      <label for="author"></label>
                      <input type="text" name="author" id="author" placeholder="author">
                  </div>
                  <!-- Category -->
                  <div class="w-50">
                      <label for="category"></label>
                      <input type="text" name="category" id="category" placeholder="category">
                  </div>
              </div>
              <br>
              <div class="d-flex gap-5">
                  <!-- Upload artist Image -->
                  <div class="d-flex gap-2 w-50">
                      <div class="w-50">
                          <label for="airtistImg" class="image-label">
                              <h1>+</h1>
                              <p>Add artist image</p>
                              <p>max size 5mb</p>
                          </label>
                          <input type="file" name="airtistImg" id="airtistImg">
                      </div>
                      <div class="w-50 airtistImg"></div>
                  </div>
                  <!-- Upload Cover image -->
                  <div class="d-flex gap-2 w-50">
                      <div class="w-50">
                          <label for="imageCover" class="image-label">
                              <h1>+</h1>
                              <p>Add blog cover image</p>
                              <p>max size 5mb</p>
                          </label>
                          <input type="file" name="imageCover" id="imageCover">
                      </div>
                      <div class="w-50 imageCover"></div>
                  </div>
              </div>
              <br>
              <!-- Quote from the Artist -->
              <label for="quote"></label>
              <textarea name="quote" id="quote" placeholder="quote from the artist" cols="30" rows="1"></textarea>
              <br>
              <!-- Images and Videos -->
              <div>
                  <label for="image" class="image-label">
                      <h1>+</h1>
                      <p>Add blog Images or Videos</p>
                      <p>max size 5mb</p>
                  </label>
                  <input type="file" name="image" id="image">
                  <div class="d-flex gap-3 image-space"></div>
              </div>
              <br>
              <button type="submit" class="upload-btn">Create News</button>
          </form>
     </section>
      

     <div id="alerting"></div>
     <svg xmlns="http://www.w3.org/2000/svg" class="d-none">
          <symbol id="check-circle-fill" viewBox="0 0 16 16">
            <path d="M16 8A8 8 0 1 1 0 8a8 8 0 0 1 16 0zm-3.97-3.03a.75.75 0 0 0-1.08.022L7.477 9.417 5.384 7.323a.75.75 0 0 0-1.06 1.06L6.97 11.03a.75.75 0 0 0 1.079-.02l3.992-4.99a.75.75 0 0 0-.01-1.05z"/>
          </symbol>
          <symbol id="info-fill" viewBox="0 0 16 16">
            <path d="M8 16A8 8 0 1 0 8 0a8 8 0 0 0 0 16zm.93-9.412-1 4.705c-.07.34.029.533.304.533.194 0 .487-.07.686-.246l-.088.416c-.287.346-.92.598-1.465.598-.703 0-1.002-.422-.808-1.319l.738-3.468c.064-.293.006-.399-.287-.47l-.451-.081.082-.381 2.29-.287zM8 5.5a1 1 0 1 1 0-2 1 1 0 0 1 0 2z"/>
          </symbol>
          <symbol id="exclamation-triangle-fill" viewBox="0 0 16 16">
            <path d="M8.982 1.566a1.13 1.13 0 0 0-1.96 0L.165 13.233c-.457.778.091 1.767.98 1.767h13.713c.889 0 1.438-.99.98-1.767L8.982 1.566zM8 5c.535 0 .954.462.9.995l-.35 3.507a.552.552 0 0 1-1.1 0L7.1 5.995A.905.905 0 0 1 8 5zm.002 6a1 1 0 1 1 0 2 1 1 0 0 1 0-2z"/>
          </symbol>
     </svg>

     <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
     <script src="admin.js"></script>
     <script>
          let alerting = document.getElementById('alerting');
      
          function getToken() {
              return localStorage.getItem('token');
          }
      
          function saveToken(token) {
              localStorage.setItem('token', token);
          }
      
          function logout() {
              localStorage.removeItem('token');
              window.location.href = '/login.html';
          }
      
          function showAlertAndLogout(message) {
              alerting.innerHTML = `
                  <div class="alert alert-danger d-flex align-items-center" role="alert">
                      <svg class="bi flex-shrink-0 me-2" role="img" aria-label="Danger:">
                          <use xlink:href="#exclamation-triangle-fill"/>
                      </svg>
                      <div>
                          ${message}
                      </div>
                  </div>
              `;
              setTimeout(() => {
                  logout();
              }, 10000); // Wait for 10 seconds before logging out
          }
      
          function checkToken() {
              const token = getToken();
              if (!token) {
                  showAlertAndLogout('An error occurred submitting your request. Check your network connection');
                  return;
              }
      
              const payload = JSON.parse(atob(token.split('.')[1]));
              const expiry = payload.exp * 1000;
              const now = Date.now();
      
              if (now > expiry) {
                  showAlertAndLogout('Session expired. You will be logged out.');
              }
          }
      
          // Check token expiration on page load
          window.onload = () => {
              checkToken();
              setInterval(checkToken, 60 * 1000); // Check every minute
          };
      
          document.getElementById('new-form').addEventListener('submit', async function (e) {
              e.preventDefault();
              const formData = new FormData(this);
      
              try {
                  const response = await fetch('/api/v1/blog/upload', {
                      method: 'POST',
                      body: formData
                  });
      
                  const data = await response.json();
      
                  if (data.success) {
                      alerting.innerHTML = `
                      <div class="alert alert-success d-flex align-items-center" role="alert">
                          <svg class="bi flex-shrink-0 me-2" role="img" aria-label="Success:"><use xlink:href="#info-fill"/></svg>
                          <div>
                          Successfully Created
                          </div>
                      </div>
                      `;
                  } else {
                      alerting.innerHTML = `
                      <div class="alert alert-warning d-flex align-items-center" role="alert">
                          <svg class="bi flex-shrink-0 me-2" role="img" aria-label="Danger:"><use xlink:href="#exclamation-triangle-fill"/></svg>
                          <div>
                          An error occurred submitting your request
                          </div>
                      </div>`;
                  }
                  setTimeout(() => {
                      alerting.innerHTML = "";
                  }, 5000); // Clear alert after 5 seconds
      
              } catch (error) {
                  alerting.innerHTML = `
                  <div class="alert alert-danger d-flex align-items-center" role="alert">
                      <svg class="bi flex-shrink-0 me-2" role="img" aria-label="Danger:"><use xlink:href="#exclamation-triangle-fill"/></svg>
                      <div>
                      An error occurred submitting your request
                      </div>
                  </div>`;
                  setTimeout(() => {
                      alerting.innerHTML = "";
                  }, 5000); // Clear alert after 5 seconds
              }
          });
      
          // Function to display alert messages
          function showAlert(message, type) {
              alerting.innerHTML = `
                  <div class="alert alert-${type} d-flex align-items-center" role="alert">
                      <svg class="bi flex-shrink-0 me-2" role="img" aria-label="${type.charAt(0).toUpperCase() + type.slice(1)}:"><use xlink:href="#${type === 'danger' ? 'exclamation-triangle-fill' : 'info-fill'}"/></svg>
                      <div>${message}</div>
                  </div>`;
              setTimeout(() => {
                  alerting.innerHTML = "";
              }, 5000);
          }
      
          // Fetch blogs and display them
          function fetchBlogs() {
               axios.get('/api/v1/blog/blogss')
                   .then(response => {
                       console.log(response.data); // Debugging: Log the response data
                       const blogs = response.data;
           
                       if (!blogs || !Array.isArray(blogs)) {
                           showAlert('Invalid response format', 'danger');
                           return;
                       }
           
                       const blogList = document.getElementById('blogList');
                       blogList.innerHTML = ''; // Clear existing content
           
                       blogs.forEach((blog, index) => {
                           const blogItem = document.createElement('div');
                           blogItem.classList.add('news');
                           blogItem.innerHTML = `
                               <div class="infromate">
                                   <h2 class="title">${blog.title}</h2>
                                   <p class="content">${blog.content}</p>
                                   <div class="d-flex gap-3">
                                       <p class="author">${blog.author}</p>
                                       <p class="category">${blog.category}</p>
                                   </div>
                                   <p class="publication_date">${new Date(blog.publication_date).toLocaleDateString()}</p>
                               </div>
                               <div class="btns">
                                   <button class="delbutton editBtn" type="button" onclick="update_news('${blog._id}')">
                                       <span class="button__text">Edit</span>
                                       <span class="button__icon">
                                           <svg viewBox="0 0 512 512" class="svg">
                                               <path d="M410.3 231l11.3-11.3-33.9-33.9-62.1-62.1L291.7 89.8l-11.3 11.3-22.6 22.6L58.6 322.9c-10.4 10.4-18 23.3-22.2 37.4L1 480.7c-2.5 8.4-.2 17.5 6.1 23.7s15.3 8.5 23.7 6.1l120.3-35.4c14.1-4.2 27-11.8 37.4-22.2L387.7 253.7 410.3 231zM160 399.4l-9.1 22.7c-4 3.1-8.5 5.4-13.3 6.9L59.4 452l23-78.1c1.4-4.9 3.8-9.4 6.9-13.3l22.7-9.1v32c0 8.8 7.2 16 16 16h32zM362.7 18.7L348.3 33.2 325.7 55.8 314.3 67.1l33.9 33.9 62.1 62.1 33.9 33.9 11.3-11.3 22.6-22.6 14.5-14.5c25-25 25-65.5 0-90.5L453.3 18.7c-25-25-65.5-25-90.5 0zm-47.4 168l-144 144c-6.2 6.2-16.4 6.2-22.6 0s-6.2-16.4 0-22.6l144-144c6.2-6.2 16.4-6.2 22.6 0s6.2 16.4 0 22.6z"></path>
                                           </svg>
                                       </span>
                                   </button>
                                   <button class="delbutton" type="button" onclick="delete_news('${blog._id}')">
                                       <span class="button__text">Delete</span>
                                       <span class="button__icon">
                                           <svg class="svg" height="512" viewBox="0 0 512 512" width="512" xmlns="http://www.w3.org/2000/svg">
                                               <title></title>
                                               <path d="M112,112l20,320c.95,18.49,14.4,32,32,32H348c17.67,0,30.87-13.51,32-32l20-320" style="fill:none;stroke:#fff;stroke-linecap:round;stroke-linejoin:round;stroke-width:32px"></path>
                                               <line style="stroke:#fff;stroke-linecap:round;stroke-miterlimit:10;stroke-width:32px" x1="80" x2="432" y1="112" y2="112"></line>
                                               <path d="M192,112V72h0a23.93,23.93,0,0,1,24-24h80a23.93,23.93,0,0,1,24,24h0v40" style="fill:none;stroke:#fff;stroke-linecap:round;stroke-linejoin:round;stroke-width:32px"></path>
                                               <line style="fill:none;stroke:#fff;stroke-linecap:round;stroke-linejoin:round;stroke-width:32px" x1="256" x2="256" y1="176" y2="400"></line>
                                               <line style="fill:none;stroke:#fff;stroke-linecap:round;stroke-linejoin:round;stroke-width:32px" x1="184" x2="192" y1="176" y2="400"></line>
                                               <line style="fill:none;stroke:#fff;stroke-linecap:round;stroke-linejoin:round;stroke-width:32px" x1="328" x2="320" y1="176" y2="400"></line>
                                           </svg>
                                       </span>
                                   </button>
                               </div>`;
                           blogList.appendChild(blogItem);
                       });
                   })
                   .catch(error => {
                       showAlert('Failed to fetch blogs', 'danger');
                       console.error('Error fetching blogs:', error); // Debugging: Log the error
                   });
          }
           
         // Update Blog
          function update_news(news_id) {
               console.log('Updating blog with ID:', news_id); // Debugging
          
               axios.get(`/api/v1/blog/blogss/${news_id}`)
               .then(response => {
                    const blog = response.data;
          
                    // Debugging: log the blog data
                    console.log('Fetched blog data:', blog);
          
                    // Populate the form with existing blog details for editing
                    if (blog.title) {
                         document.getElementById('title').value = blog.title;
                    }
                    if (blog.content) {
                         document.getElementById('content').value = blog.content;
                    }
                    if (blog.author) {
                         document.getElementById('author').value = blog.author;
                    }
                    if (blog.category) {
                         document.getElementById('category').value = blog.category;
                    }
                    if (blog.quote) {
                         document.getElementById('quote').value = blog.quote;
                    }
          
                    // Populate image containers with existing images
                    if (blog.airtistImg) {
                         const airtistImgContainer = document.querySelector('.airtistImg');
                         airtistImgContainer.innerHTML = `<img src="${blog.airtistImg}" alt="Artist Image" style="max-width: 100%; max-height: 100%;">`;
                    }
                    if (blog.imageCover) {
                         const imageCoverContainer = document.querySelector('.imageCover');
                         imageCoverContainer.innerHTML = `<img src="${blog.imageCover}" alt="Cover Image" style="max-width: 100%; max-height: 100%;">`;
                    }
                    if (blog.image) {
                         const imageSpaceContainer = document.querySelector('.image-space');
                         imageSpaceContainer.innerHTML = `<img src="${blog.image}" alt="Blog Image" style="max-width: 100%; max-height: 100%;">`;
                    }
          
                    // Update form submission to handle editing
                    const form = document.getElementById('new-form');
                    document.querySelector("#newForm").style.display = "block";
                    form.onsubmit = async function (e) {
                         e.preventDefault();
                         const formData = new FormData(this);
                         formData.append('news_id', news_id); // Add news_id to the form data
          
                         try {
                              const response = await fetch(`/api/v1/blog/blogss/${news_id}`, {
                                   method: 'PUT',
                                   body: formData
                              });
          
                              const data = await response.json();
                              if (data.success) {
                                   showAlert('Blog updated successfully', 'success');
                              } else {
                                   showAlert('An error occurred updating the blog', 'danger');
                              }
                              fetchBlogs(); // Refresh blog list
                         } catch (error) {
                              showAlert('An error occurred updating the blog', 'danger');
                         }
                    };
               })
               .catch(error => {
                    showAlert('Failed to fetch blog details', 'danger');
                    console.error('Error fetching blog details:', error);
               });
          }
          
          
          // Delete Blog
          function delete_news(news_id) {
               console.log('Deleting blog with ID:', news_id); // Debugging

               axios.delete(`/api/v1/blog/blogss/${news_id}`)
                    .then(response => {
                         showAlert('Blog deleted successfully', 'success');
                         fetchBlogs(); // Refresh blog list
                    })
                    .catch(error => {
                         showAlert('Failed to delete blog', 'danger');
                         console.error('Error deleting blog:', error);
                    });
          }

          // Call fetchBlogs on page load
          window.onload = () => {
               fetchBlogs();
               checkToken();
               setInterval(checkToken, 60 * 1000); // Check every minute
          };
     </script>
      
</body>
</html>